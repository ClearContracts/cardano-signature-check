<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardano Signature Verifier</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Cardano Signature Verifier</h1>
        <p>Verify CIP-8 wallet signatures collected from Cardano</p>
      </header>

      <form id="verify-form">
        <div class="form-group">
          <label for="stakeAddress">Stake Address / Public Key</label>
          <input
            type="text"
            id="stakeAddress"
            name="stakeAddress"
            placeholder="addr1... or stake1..."
            required
          />
        </div>

        <div class="form-group">
          <label for="message">Original Message</label>
          <textarea
            id="message"
            name="message"
            rows="3"
            placeholder="The exact message that was signed"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="key">Key (COSE_Key hex from wallet.signData)</label>
          <textarea
            id="key"
            name="key"
            rows="2"
            placeholder="a4010103272006215820..."
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="signature"
            >Signature (COSE_Sign1 hex from wallet.signData)</label
          >
          <textarea
            id="signature"
            name="signature"
            rows="3"
            placeholder="845846a201276761..."
            required
          ></textarea>
        </div>

        <button type="submit" id="submit-btn">Verify Signature</button>
      </form>

      <div id="result" class="result hidden">
        <div class="result-icon"></div>
        <div class="result-message"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById("verify-form");
      const resultDiv = document.getElementById("result");
      const submitBtn = document.getElementById("submit-btn");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.textContent = "Verifying...";
        resultDiv.classList.add("hidden");

        const stakeAddress = document
          .getElementById("stakeAddress")
          .value.trim();
        const message = document.getElementById("message").value.trim();
        const key = document.getElementById("key").value.trim();
        const signatureHex = document.getElementById("signature").value.trim();

        // Build the signature object expected by MeshJS
        const signature = { key, signature: signatureHex };

        try {
          const response = await fetch("/verify", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ stakeAddress, message, signature }),
          });

          const data = await response.json();

          resultDiv.classList.remove("hidden", "valid", "invalid");
          resultDiv.classList.add(data.valid ? "valid" : "invalid");

          resultDiv.querySelector(".result-icon").textContent = data.valid
            ? "✓"
            : "✗";
          resultDiv.querySelector(".result-message").textContent =
            data.error || data.message;
        } catch (error) {
          resultDiv.classList.remove("hidden", "valid");
          resultDiv.classList.add("invalid");
          resultDiv.querySelector(".result-icon").textContent = "✗";
          resultDiv.querySelector(
            ".result-message"
          ).textContent = `Error: ${error.message}`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Verify Signature";
        }
      });
    </script>
  </body>
</html>
